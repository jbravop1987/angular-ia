name: Angular 18 CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build Angular
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clonar repo
      - uses: actions/checkout@v4

      # 2️⃣ Configurar Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      # 3️⃣ Instalar dependencias
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Build Angular
      - name: Build Angular
        run: npm run build -- --configuration=production

      # 5️⃣ Copiar build a carpeta de Docker
      - name: Prepare Docker context
        run: |
          mkdir -p docker/html
          cp -r dist/angular-ia-v3/browser/* docker/html/

      # 6️⃣ Build de la imagen Docker
      - name: Build Docker image
        run: |
          docker build -t mydockerhubuser/nginx_server:latest docker/

      # 7️⃣ (Opcional) Push a Docker Hub si quieres mantenerla en registry público)
      # - name: Push Docker image
      #   run: |
      #     docker push mydockerhubuser/nginx_server:latest

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: SSH Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p ${{ secrets.VPS_PATH }}
            cd ${{ secrets.VPS_PATH }}

            # Copiar Dockerfile y carpeta html al VPS
            rm -rf docker
            mkdir -p docker/html
            exit 0  # Aquí puedes usar scp-action para subir los archivos si quieres

            # Build y run del contenedor
            docker build -t nginx_server:latest docker/
            docker stop nginx_server || true
            docker rm nginx_server || true
            docker run -d --name nginx_server -p 80:80 nginx_server:latest
